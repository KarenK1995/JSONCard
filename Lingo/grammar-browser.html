<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Grammar Lessons</title>
    <link rel="stylesheet" href="/lingo/grammar-browser.css" />
  </head>
  <body>
    <div class="page">
      <header class="hero">
        <div>
          <p class="eyebrow">Lingo</p>
          <h1>Grammar Lessons</h1>
          <p class="subtitle">
            Browse every lesson by level and jump straight into practice.
          </p>
        </div>
        <div class="controls">
          <div class="control">
            <label for="language">Language</label>
            <select id="language" name="language" aria-label="Select language"></select>
          </div>
          <div class="control">
            <label for="search">Search</label>
            <input
              id="search"
              name="search"
              type="search"
              placeholder="Search lessons"
              autocomplete="off"
            />
          </div>
        </div>
      </header>

      <main>
        <section class="status" aria-live="polite" data-status></section>
        <div class="levels" data-levels></div>
      </main>

      <footer class="footer">
        <span>Need help? Contact The General Apps team.</span>
        <span>All lessons are optimized for mobile and desktop.</span>
      </footer>
    </div>

    <script>
      const supportedLanguages = [
        { code: "en", label: "English" },
        { code: "ru", label: "Русский" },
        { code: "uk", label: "Українська" },
        { code: "es", label: "Español" },
        { code: "fr", label: "Français" },
        { code: "ar", label: "العربية" },
        { code: "tr", label: "Türkçe" },
        { code: "it", label: "Italiano" },
        { code: "ro", label: "Română" },
        { code: "sv", label: "Svenska" },
        { code: "pt", label: "Português" },
        { code: "ko", label: "한국어" },
        { code: "ja", label: "日本語" },
        { code: "nl", label: "Nederlands" },
        { code: "zh", label: "中文" },
        { code: "hr", label: "Hrvatski" },
        { code: "hy", label: "Հայերեն" },
      ];

      const statusEl = document.querySelector("[data-status]");
      const levelsEl = document.querySelector("[data-levels]");
      const languageSelect = document.querySelector("#language");
      const searchInput = document.querySelector("#search");

      const queryParams = new URLSearchParams(window.location.search);
      const initialLanguage = (queryParams.get("ln") || "en").toLowerCase();

      const buildLessonUrl = (lessonId, language) => {
        const url = new URL(`/lingo/${lessonId}`, window.location.origin);
        url.searchParams.set("ln", language);
        return url.toString();
      };

      const setStatus = (message, type = "info") => {
        statusEl.textContent = message;
        statusEl.className = `status status--${type}`;
      };

      const normalizeQuery = (value) => value.trim().toLowerCase();

      const appendHighlightedText = (container, text, query) => {
        container.textContent = "";
        if (!text) {
          return;
        }

        if (!query) {
          container.textContent = text;
          return;
        }

        const normalizedText = text.toLowerCase();
        const normalizedQuery = query.toLowerCase();
        let startIndex = 0;
        let matchIndex = normalizedText.indexOf(normalizedQuery, startIndex);

        while (matchIndex !== -1) {
          if (matchIndex > startIndex) {
            container.append(text.slice(startIndex, matchIndex));
          }

          const highlight = document.createElement("mark");
          highlight.className = "search-highlight";
          highlight.textContent = text.slice(matchIndex, matchIndex + query.length);
          container.append(highlight);

          startIndex = matchIndex + query.length;
          matchIndex = normalizedText.indexOf(normalizedQuery, startIndex);
        }

        if (startIndex < text.length) {
          container.append(text.slice(startIndex));
        }
      };

      const renderLevels = (structure, language, query = "") => {
        levelsEl.innerHTML = "";
        const levels = structure.levels || [];
        if (!levels.length) {
          setStatus("No lessons found yet.", "warning");
          return;
        }

        const trimmedQuery = query.trim();
        const normalizedQuery = normalizeQuery(query);
        let totalLessons = 0;
        let totalMatches = 0;

        levels.forEach((level) => {
          totalLessons += (level.chapters || []).length;
        });

        levels.forEach((level) => {
          const section = document.createElement("section");
          section.className = "level";

          const header = document.createElement("div");
          header.className = "level__header";

          const title = document.createElement("h2");
          title.textContent = `${level.title} (${level.id})`;

          const count = document.createElement("p");
          const chapters = level.chapters || [];
          const filteredChapters = normalizedQuery
            ? chapters.filter((chapter) => {
                const haystack = `${chapter.id} ${chapter.title} ${chapter.description || ""}`.toLowerCase();
                return haystack.includes(normalizedQuery);
              })
            : chapters;

          totalMatches += filteredChapters.length;
          count.textContent = normalizedQuery
            ? `${filteredChapters.length} of ${chapters.length} lessons`
            : `${chapters.length} lessons`;

          if (normalizedQuery && filteredChapters.length === 0) {
            return;
          }

          header.appendChild(title);
          header.appendChild(count);
          section.appendChild(header);

          const grid = document.createElement("div");
          grid.className = "lesson-grid";

          filteredChapters.forEach((chapter) => {
            const card = document.createElement("article");
            card.className = "lesson-card";

            const cardHeader = document.createElement("div");
            cardHeader.className = "lesson-card__header";

            const idBadge = document.createElement("span");
            idBadge.className = "lesson-card__badge";
            appendHighlightedText(idBadge, chapter.id, trimmedQuery);

            const cardTitle = document.createElement("h3");
            appendHighlightedText(cardTitle, chapter.title, trimmedQuery);

            cardHeader.appendChild(idBadge);
            cardHeader.appendChild(cardTitle);

            const description = document.createElement("p");
            appendHighlightedText(description, chapter.description || "", trimmedQuery);

            const link = document.createElement("a");
            link.href = buildLessonUrl(chapter.id, language);
            link.className = "lesson-card__link";
            link.textContent = "Open lesson";

            card.appendChild(cardHeader);
            card.appendChild(description);
            card.appendChild(link);
            grid.appendChild(card);
          });

          section.appendChild(grid);
          levelsEl.appendChild(section);
        });

        if (normalizedQuery) {
          if (totalMatches === 0) {
            setStatus(`No lessons match "${trimmedQuery}".`, "warning");
          } else {
            setStatus(`Showing ${totalMatches} of ${totalLessons} lessons.`, "info");
          }
        } else {
          setStatus("", "info");
        }
      };

      const updateQueryParam = (key, value) => {
        if (value) {
          queryParams.set(key, value);
        } else {
          queryParams.delete(key);
        }
        const newUrl = queryParams.toString()
          ? `${window.location.pathname}?${queryParams.toString()}`
          : window.location.pathname;
        window.history.replaceState({}, "", newUrl);
      };

      let currentStructure = null;
      let currentLanguage = initialLanguage;

      const updateSearch = () => {
        if (!currentStructure) {
          return;
        }
        const query = searchInput.value;
        updateQueryParam("q", query);
        renderLevels(currentStructure, currentLanguage, query);
      };

      const loadStructure = async (language) => {
        setStatus("Loading lessons...", "info");
        try {
          const response = await fetch(`/api/lingo/structure?ln=${language}`);
          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            throw new Error(errorPayload.message || "Unable to load lessons.");
          }
          const data = await response.json();
          document.documentElement.lang = data.language || language;
          currentStructure = data;
          currentLanguage = data.language || language;
          renderLevels(data, currentLanguage, searchInput.value);
        } catch (error) {
          setStatus(error.message || "Unable to load lessons.", "error");
        }
      };

      supportedLanguages.forEach(({ code, label }) => {
        const option = document.createElement("option");
        option.value = code;
        option.textContent = label;
        if (code === initialLanguage) {
          option.selected = true;
        }
        languageSelect.appendChild(option);
      });

      languageSelect.addEventListener("change", (event) => {
        const language = event.target.value;
        updateQueryParam("ln", language);
        loadStructure(language);
      });

      searchInput.addEventListener("input", () => {
        updateSearch();
      });

      if (!supportedLanguages.find(({ code }) => code === initialLanguage)) {
        queryParams.set("ln", "en");
      }

      const initialSearch = queryParams.get("q") || "";
      searchInput.value = initialSearch;

      loadStructure(queryParams.get("ln") || "en");
    </script>
  </body>
</html>
